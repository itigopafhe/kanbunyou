<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãŸã—ã®é«˜æ©Ÿèƒ½ æ¼¢æ–‡ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root{--primary-color:#593c1b;--secondary-color:#0067C0;--danger-color:#c0392b;--bg-color:#f4f1e9;--card-bg-color:#fff;--text-color:#333;--base-padding:15px}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background-color:var(--bg-color);color:var(--text-color);margin:0;padding:var(--base-padding);box-sizing:border-box}
        .header h1{color:var(--primary-color);margin:0;font-size:22px;text-align:center;padding-bottom:15px}
        .tab-nav{display:flex;border-bottom:2px solid #ddd;margin-bottom:20px}.tab-btn{padding:10px 20px;border:none;background-color:transparent;font-size:16px;cursor:pointer;color:#888;border-bottom:3px solid transparent;margin-bottom:-2px}.tab-btn.active{color:var(--secondary-color);border-bottom-color:var(--secondary-color);font-weight:700}
        .view{display:none}.view.active{display:block}
        
        .main-controls{margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;align-items:stretch;justify-content:center}
        .sub-controls { padding: 15px; margin-bottom:15px; border-radius: 8px; background-color: rgba(0,0,0,0.03); border: 1px solid #e0e0e0; }
        .sub-controls h3 { font-size: 16px; margin: 0 0 10px 0; color: var(--primary-color); }
        .sub-controls .btn-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .sub-controls .btn { font-size: 13px; padding: 6px 12px; background-color: #777; }
        
        .btn{padding:10px 15px;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:700;transition:background-color .2s}
        .btn:hover{opacity:.9}
        #add-group-btn, #add-goku-btn { background-color: var(--secondary-color); flex-grow: 1; }
        .search-box{flex-grow:1;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:15px;box-sizing:border-box}
        .status-bar{text-align:left;margin:15px 0 10px;font-size:14px;color:#555}
        
        .kuhou-group { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 12px; margin-bottom: 20px; }
        .kuhou-group-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #e0e0e0; flex-wrap: wrap; gap: 10px;}
        .kuhou-group-title { font-size: 20px; font-weight: bold; }
        .subgroup-container { padding: 5px 15px 15px; }
        .subgroup { border: 1px solid #eee; border-radius: 8px; margin-top: 15px; }
        .subgroup > details > summary { list-style: none; }
        .subgroup > details > summary::-webkit-details-marker { display: none; }
        .subgroup-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f9f9f9; flex-wrap: wrap; gap: 10px; cursor: pointer; }
        .subgroup-title { font-size: 18px; font-weight: bold; color: var(--secondary-color); }
        
        .item-card-container { padding: 15px; }
        .item-card{background-color:var(--card-bg-color);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);padding:20px;display:flex;flex-direction:column;position:relative}
        .item-card h3 { margin:0 0 15px 0; font-size: 22px; }
        
        .field{border-left:3px solid #eee;padding-left:15px;margin-bottom:15px}.field-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}.field-title{font-size:12px;color:#888;font-weight:700}.toggle-visibility{cursor:pointer;font-size:18px;user-select:none}.field .content{line-height:1.6;white-space:pre-wrap;}
        
        .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .actions button { background: none; border: 1px solid #ccc; color:#555; border-radius:5px; font-size: 14px; cursor: pointer; padding: 5px 8px; font-weight:normal;}
        .actions button:hover { background-color: #eee; }
        .actions .reorder-btn { font-size: 16px; padding: 2px 8px; }
        .card-actions{margin-top:auto;padding-top:15px;text-align:right;border-top:1px solid #f0f0f0;display:flex;gap:8px;justify-content:flex-end;}.card-actions button{background:0 0;border:1px solid #ccc;border-radius:5px;padding:5px 10px;cursor:pointer;font-size:12px;}.card-actions button:hover{background-color:#eee}
        .delete-btn{border-color:var(--danger-color);color:var(--danger-color)}.delete-btn:hover{background-color:var(--danger-color);color:#fff}
        
        .hidden { display: none !important; }
        button:disabled { opacity: 0.5; cursor: not-allowed; background-color: #ccc !important; }

        .card-tags { padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .card-tag { display: inline-block; background-color: #eee; color: #555; padding: 3px 8px; font-size: 12px; border-radius: 10px; margin-right: 5px; margin-bottom: 5px; }
        
        .details-section { margin-top: 15px; }
        .details-section summary { cursor: pointer; font-weight: bold; color: var(--secondary-color); padding: 8px 0; border-top: 1px solid #f0f0f0; }
        .details-section .details-content { padding-top: 10px; }
        .details-section .details-content p { margin: 0 0 15px; line-height: 1.6; }
        .details-section .details-content p strong { display: block; margin-bottom: 5px; font-size: 13px; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .details-photo { max-width: 100%; border-radius: 8px; margin-top: 10px; }

        .goku-entry { border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px; }
        .goku-entry:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .goku-entry-header { font-weight: bold; font-size: 1.1em; }
        .goku-entry-pos { font-size: 0.9em; color: #666; margin-left: 8px; }
        .goku-entry-meanings { list-style-type: decimal; padding-left: 20px; }

        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);z-index:1000}
        #modal-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:var(--bg-color);padding:25px;border-radius:12px;box-shadow:0 5px 25px rgba(0,0,0,.2);z-index:1001;width:90%;max-width:600px;max-height:85vh;display:flex;flex-direction:column}
        #modal-container h2{margin-top:0;color:var(--primary-color)}
        .modal-content{overflow-y:auto;flex-grow:1}
        .modal-content form{display:flex;flex-direction:column;gap:15px}
        .modal-content label{font-weight:700;font-size:14px;color:var(--primary-color);margin-bottom:-10px}
        .modal-content fieldset { border: 1px solid #ccc; border-radius: 8px; padding: 10px 15px; margin-top: 10px; }
        .modal-content legend { font-weight: bold; padding: 0 5px; }
        .modal-content input[type=text],.modal-content textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:16px;box-sizing:border-box}
        .modal-content textarea{min-height:80px;resize:vertical}
        #photo-preview { max-width: 150px; max-height: 150px; margin-top: 10px; border: 1px solid #ccc; background: #fff; padding: 5px; border-radius: 4px; }
        
        .modal-actions{display:flex;align-items:center;gap:10px;margin-top:25px;flex-shrink:0}
        .modal-actions .left-action { margin-right: auto; }
        .modal-actions .btn { color: #fff !important; }
        .modal-actions .btn-save{ background-color: var(--secondary-color); }
        .modal-actions .btn-cancel{ background-color: #888; }
        .modal-actions .btn-sub-action { background-color: #6c757d; }
    
        :root { --tag-filter-text-color: #0067C0; --tag-filter-bg-color: #ffffff; --tag-filter-border-color: #0067C0; --tag-filter-active-text-color: #ffffff; --tag-filter-active-bg-color: #0067C0; }
        .tag-filter-system-container { width: 100%; text-align: left; padding: 10px 0; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin-bottom: 20px;}
        .tag-filter-btn { background-color: var(--tag-filter-bg-color); color: var(--tag-filter-text-color); border: 1px solid var(--tag-filter-border-color); border-radius: 15px; padding: 6px 14px; margin: 5px; cursor: pointer; transition: all 0.2s ease; font-size: 14px; font-weight: bold; }
        .tag-filter-btn:hover { opacity: 0.8; }
        .tag-filter-btn.active { background-color: var(--tag-filter-active-bg-color); color: var(--tag-filter-active-text-color); border-color: var(--tag-filter-active-bg-color); }
    </style>
</head>
<body>
    <header class="header"><h1>ã‚ãŸã—ã®é«˜æ©Ÿèƒ½ æ¼¢æ–‡ã‚¢ãƒ—ãƒª</h1></header>
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="kuhou-list">å¥æ³•ä¸€è¦§</button>
        <button class="tab-btn" data-tab="training">å¥æ³•ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</button>
        <button class="tab-btn" data-tab="goku-list">èªå¥å¸³</button>
    </nav>
    <main>
        <div id="kuhou-list-view" class="view active">
            <div class="main-controls"><input type="search" id="kuhou-search-box" class="search-box" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—ã€å¥æ³•ã€ä¾‹æ–‡ã€è§£èª¬ãªã©ã§æ¤œç´¢..."><button id="add-group-btn" class="btn">ï¼‹ æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ </button></div>
            <div class="sub-controls"><<h3>å¥æ³•ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3><div class="btn-group"><button class="btn kuhou-action" data-action="import">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button><button class="btn kuhou-action" data-action="export-excel">Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button><button class="btn kuhou-action" data-action="download-template">Excelé››å½¢DL</button></div></div>
            <div id="kuhou-tag-filter-container"></div>
            <div class="status-bar"><span>â˜… </span><span id="kuhou-count-display"></span></div>
            <div id="kuhou-container"></div>
        </div>
        <div id="training-view" class="view"><div style="text-align: center; padding: 40px; background: #fff; border-radius: 12px;"><h2>å¥æ³•ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæº–å‚™ä¸­ï¼‰</h2><p>ä»Šå¾Œã€ã“ã“ã«ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚</p></div></div>
        <div id="goku-list-view" class="view">
             <div class="main-controls"><input type="search" id="goku-search-box" class="search-box" placeholder="èªå¥ã€èª­ã¿ã€æ„å‘³ã€ä¾‹æ–‡ãªã©ã§æ¤œç´¢..."><button id="add-goku-btn" class="btn">ï¼‹ æ–°è¦èªå¥ã‚’è¿½åŠ </button></div>
             <div class="sub-controls"><<h3>èªå¥ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3><div class="btn-group"><button class="btn goku-action" data-action="import">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button><button class="btn goku-action" data-action="export-excel">Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button><button class="btn goku-action" data-action="download-template">Excelé››å½¢DL</button><button class="btn goku-action" data-action="share" style="background-color: #17a2b8;">å…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆ</button></div></div>
            <div id="goku-tag-filter-container"></div>
            <div class="status-bar"><span>â˜… </span><span id="goku-count-display"></span></div>
            <div id="goku-container" class="item-container" style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));"></div>
        </div>
    </main>
    <div id="modal-overlay" class="hidden"></div>
    <div id="modal-container" class="hidden"></div>
    <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .csv">
    <script>
    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
    const sanitizeHTML = (str) => { if (!str) return ''; const temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; };
    XLSX.utils.book_new_append_json = (data, sheetName="Sheet1") => { const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(data); XLSX.utils.book_append_sheet(wb, ws, sheetName); return wb; };

    class TagFilter {
        constructor(containerId, items, onFilterChange) { this.container = document.getElementById(containerId); if (!this.container) { return; } this.container.className = 'tag-filter-system-container'; this.allItems = items; this.onFilterChange = onFilterChange; this.activeTags = []; }
        _extractAllTags() { return [...new Set(this.allItems.flatMap(item => item.tags || []))].sort((a, b) => a.localeCompare(b, 'ja')); }
        _handleTagClick(tag) { if (tag === 'all') { this.activeTags = []; } else { const index = this.activeTags.indexOf(tag); if (index > -1) { this.activeTags.splice(index, 1); } else { this.activeTags.push(tag); } } this.render(); if (typeof this.onFilterChange === 'function') { this.onFilterChange(this.activeTags); } }
        render() { this.container.innerHTML = ''; const allTags = this._extractAllTags(); if (allTags.length === 0) {this.container.style.display = 'none'; return;} this.container.style.display = 'block'; const allBtn = document.createElement('button'); allBtn.className = 'tag-filter-btn'; allBtn.textContent = 'ã™ã¹ã¦è¡¨ç¤º'; if (this.activeTags.length === 0) { allBtn.classList.add('active'); } allBtn.addEventListener('click', () => this._handleTagClick('all')); this.container.appendChild(allBtn); allTags.forEach(tag => { const btn = document.createElement('button'); btn.className = 'tag-filter-btn'; btn.textContent = tag; if (this.activeTags.includes(tag)) { btn.classList.add('active'); } btn.addEventListener('click', () => this._handleTagClick(tag)); this.container.appendChild(btn); }); }
    }
    document.addEventListener('DOMContentLoaded', () => {
        let kuhouData = [], gokuData = [], activeTab = 'kuhou-list', kuhouSearchQuery = '', gokuSearchQuery = '', activeKuhouTags = [], activeGokuTags = [], currentModalSaveHandler = null, currentImportHandler = null;
        const modalOverlay = document.getElementById('modal-overlay'), modalContainer = document.getElementById('modal-container'), importFileInput = document.getElementById('import-file-input');
        const kuhouSearchBox = document.getElementById('kuhou-search-box'), gokuSearchBox = document.getElementById('goku-search-box');
        
        const getDefaultKuhouData = () => [ { groupId: 1, groupTitle: "å¦å®šå½¢", subgroups: [ { subgroupId: 101, subgroupTitle: "ä¸", tags: ["åŸºæœ¬", "å¦å®š"], card: { hakubun: "å­¦è€Œä¸æ€å‰‡ç½”ã€‚", kakikudashi: "å­¦ã³ã¦æ€ã¯ã–ã‚Œã°å‰‡ã¡ç½”ã—ã€‚", translation: "å­¦ã‚“ã§ã‚‚è€ƒãˆãªã‘ã‚Œã°ã€èº«ã«ã¤ã‹ãªã„ã€‚", explanation: "å˜ç´”ãªæ‰“ã¡æ¶ˆã—ã€‚ã€Œã€œãšã€ã¨èª­ã‚€ã€‚" }}, { subgroupId: 102, subgroupTitle: "é", tags: ["å¦å®š"], card: { hakubun: "å­éæˆ‘ã€‚", kakikudashi: "å­ã¯æˆ‘ã«ã‚ã‚‰ãšã€‚", translation: "ã‚ãªãŸã¯ç§ã§ã¯ãªã„ã€‚", explanation: "åè©ã‚’æ‰“ã¡æ¶ˆã™ã€‚ã€Œã€œã«ã‚ã‚‰ãšã€ã¨èª­ã‚€ã€‚" }} ]}, { groupId: 2, groupTitle: "ä½¿å½¹å½¢", subgroups: [ { subgroupId: 201, subgroupTitle: "ä½¿", tags: ["ä½¿å½¹"], card: { hakubun: "ç‹ä½¿äººå•ä¹‹ã€‚", kakikudashi: "ç‹äººã‚’ã—ã¦ä¹‹ã‚’å•ã¯ã—ã‚€ã€‚", translation: "ç‹ãŒå®¶æ¥ã«ã“ã‚Œã‚’è³ªå•ã•ã›ãŸã€‚", explanation: "ã€ŒAã‚’ã—ã¦Bã—ã‚€ã€ã¨èª­ã‚€ã€‚" }} ]} ];
        const getDefaultGokuData = () => [ { id: 1, title: 'å‰‡', variants: ['å³', 'ä¹ƒ', 'ä¾¿'], tags: ["é‡è¦èª", "æ¥ç¶šè©"], commonMemo: 'æ–‡è„ˆã«ã‚ˆã£ã¦ä½¿ã‚ã‚Œã‚‹æ¼¢å­—ãŒç•°ãªã‚‹ãŒã€æ„å‘³ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚‚å°‘ã—ãšã¤é•ã†ã€‚', entries: [{ reading: "ã™ãªã¯ã¡", partOfSpeech: "æ¥ç¶šè©", meanings: ["ã€å‰‡ã€‘å‰ä»¶ãŒå¾Œä»¶ã®ç†ç”±ãƒ»æ¡ä»¶ã¨ãªã‚‹å ´åˆã€‚ã€Œã€œãªã‚‰ã°ã€ã€Œã€œã®å ´åˆã¯ã€ã€‚", "ã€å³ã€‘äºŒã¤ã®ã‚‚ã®ãŒã‚¤ã‚³ãƒ¼ãƒ«ã§ã‚ã‚‹ã€ã¾ãŸã¯ã™ãã«è¡Œå‹•ãŒç§»ã‚‹å ´åˆã€‚ã€Œã¾ã•ã«ã€ã€Œã™ãã«ã€ã€‚", "ã€ä¹ƒã€‘æ„å¤–ãªçµæœã‚„ã€å‰ä»¶ã‚’å—ã‘ã¦ã‚ˆã†ã‚„ãå¾Œä»¶ãŒèµ·ã“ã‚‹å ´åˆã€‚ã€Œãã“ã§ã‚ˆã†ã‚„ãã€ã€Œæ„å¤–ã«ã‚‚ã€ã€‚"]}]} ];

        const loadData = () => {
            try { const storedKuhou = localStorage.getItem('kanbunKuhou'); kuhouData = storedKuhou ? JSON.parse(storedKuhou) : getDefaultKuhouData();
            } catch (e) { console.error("å¥æ³•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚", e); kuhouData = getDefaultKuhouData(); }
            try {
                const storedGoku = localStorage.getItem('kanbunGoku'); let rawGokuData = storedGoku ? JSON.parse(storedGoku) : getDefaultGokuData();
                gokuData = rawGokuData.map(item => { if (item.entries && Array.isArray(item.entries)) return item; return { id: item.id, title: item.title, tags: item.tags || [], commonMemo: item.memo || "", photo: item.photo || "", entries: [{ reading: item.reading || "", partOfSpeech: "", meanings: (item.meanings || []).map(m=>(typeof m === 'string' ? m : m.text)), example: item.example || {} }] }; });
            } catch (e) { console.error("èªå¥ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚", e); gokuData = getDefaultGokuData(); }
        };
        const saveData = () => { localStorage.setItem('kanbunKuhou', JSON.stringify(kuhouData)); localStorage.setItem('kanbunGoku', JSON.stringify(gokuData)); };
        const saveAndRender = () => { saveData(); render(); };
        const switchView = (tabId) => { activeTab = tabId; document.querySelectorAll('.view').forEach(view => view.classList.toggle('active', view.id === `${tabId}-view`)); document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId)); render(); };
        const render = () => { if (activeTab === 'kuhou-list') renderKuhouList(); if (activeTab === 'goku-list') renderGokuList(); };
        
        const renderKuhouList = () => {
            const container = document.getElementById('kuhou-container');
            const query = kuhouSearchQuery.toLowerCase();
            const searchFilteredData = query ? kuhouData.map(group => ({ ...group, subgroups: group.subgroups.filter(sg => { const card = sg.card || {}; return (group.groupTitle||'').toLowerCase().includes(query) || (sg.subgroupTitle||'').toLowerCase().includes(query) || (sg.tags||[]).join(',').toLowerCase().includes(query) || (card.hakubun||'').toLowerCase().includes(query) || (card.kakikudashi||'').toLowerCase().includes(query) || (card.translation||'').toLowerCase().includes(query) || (card.explanation||'').toLowerCase().includes(query) || (card.memo||'').toLowerCase().includes(query) || (card.example?.hakubun||'').toLowerCase().includes(query) || (card.example?.kakikudashi||'').toLowerCase().includes(query) || (card.example?.translation||'').toLowerCase().includes(query); }) })).filter(group => group.subgroups.length > 0) : kuhouData;
            const allSubgroupsForTagging = searchFilteredData.flatMap(g => g.subgroups);
            const tagFilter = new TagFilter('kuhou-tag-filter-container', allSubgroupsForTagging, (newTags) => { activeKuhouTags = newTags; renderKuhouList(); });
            tagFilter.activeTags = activeKuhouTags; tagFilter.render();
            container.innerHTML = ''; let totalKuhouCount = 0;
            searchFilteredData.forEach((group, groupIndex) => {
                const filteredSubgroups = group.subgroups.filter(subgroup => activeKuhouTags.every(tag => (subgroup.tags || []).includes(tag)));
                if (filteredSubgroups.length === 0 && query) return;
                const groupEl = document.createElement('div'); groupEl.className = 'kuhou-group'; groupEl.dataset.groupId = group.groupId;
                const subgroupsHTML = filteredSubgroups.map(subgroup => {
                    totalKuhouCount++; const card = subgroup.card; const tagsHTML = (subgroup.tags || []).map(tag => `<span class="card-tag">${sanitizeHTML(tag)}</span>`).join('');
                    const detailsHTML = (card.explanation || card.memo || card.example?.hakubun) ? `<details class="details-section"><summary>è§£èª¬ãƒ»ä¾‹æ–‡ãƒ»ãƒ¡ãƒ¢</summary><div class="details-content">${card.explanation ? `<p><strong>è§£èª¬</strong>${sanitizeHTML(card.explanation)}</p>` : ''}${card.example?.hakubun ? `<p><strong>ä¾‹æ–‡</strong>${sanitizeHTML(card.example.hakubun)}<br>${sanitizeHTML(card.example.kakikudashi)}<br>${sanitizeHTML(card.example.translation)}<br>(${sanitizeHTML(card.example.source) || 'å‡ºå…¸ä¸æ˜'})</p>` : ''}${card.memo ? `<p><strong>ãƒ¡ãƒ¢</strong>${sanitizeHTML(card.memo)}</p>` : ''}</div></details>` : '';
                    return `<div class="subgroup" data-subgroup-id="${subgroup.subgroupId}"><details><summary class="subgroup-header"><span class="subgroup-title">${sanitizeHTML(subgroup.subgroupTitle)}</span><div class="actions"><button class="edit-subgroup-btn">ç·¨é›†</button><button class="delete-subgroup-btn delete-btn">å‰Šé™¤</button></div></summary><div class="item-card-container"><div class="item-card"><div class="field"><div class="field-header"><span class="field-title">ç™½æ–‡</span></div><div class="content">${sanitizeHTML(card.hakubun) || ''}</div></div><div class="field"><div class="field-header"><span class="field-title">æ›¸ãä¸‹ã—æ–‡</span><span class="toggle-visibility" data-field="kakikudashi">ğŸ‘ï¸</span></div><div class="content kakikudashi hidden">${sanitizeHTML(card.kakikudashi) || ''}</div></div><div class="field"><div class="field-header"><span class="field-title">ç¾ä»£èªè¨³</span><span class="toggle-visibility" data-field="translation">ğŸ‘ï¸</span></div><div class="content translation hidden">${sanitizeHTML(card.translation) || ''}</div></div>${detailsHTML}<div class="card-tags">${tagsHTML}</div></div></div></details></div>`;
                }).join('');
                if (filteredSubgroups.length === 0 && !query) { groupEl.innerHTML = `<div class="kuhou-group-header"><span class="kuhou-group-title">${sanitizeHTML(group.groupTitle)}</span><div class="actions"><button class="add-subgroup-btn">ï¼‹ å¥æ³•è¿½åŠ </button><button class="edit-group-btn">ç·¨é›†</button><button class="delete-group-btn delete-btn">å‰Šé™¤</button><button class="reorder-group-up-btn reorder-btn" ${groupIndex === 0 ? 'disabled' : ''}>ğŸ”¼</button><button class="reorder-group-down-btn reorder-btn" ${groupIndex === kuhouData.length - 1 ? 'disabled' : ''}>ğŸ”½</button></div></div><div class="subgroup-container" style="padding:15px; color:#888;">å¥æ³•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`; }
                else { groupEl.innerHTML = `<div class="kuhou-group-header"><span class="kuhou-group-title">${sanitizeHTML(group.groupTitle)}</span><div class="actions"><button class="add-subgroup-btn">ï¼‹ å¥æ³•è¿½åŠ </button><button class="edit-group-btn">ç·¨é›†</button><button class="delete-group-btn delete-btn">å‰Šé™¤</button><button class="reorder-group-up-btn reorder-btn" ${groupIndex === 0 ? 'disabled' : ''}>ğŸ”¼</button><button class="reorder-group-down-btn reorder-btn" ${groupIndex === kuhouData.length - 1 ? 'disabled' : ''}>ğŸ”½</button></div></div><div class="subgroup-container">${subgroupsHTML}</div>`; }
                container.appendChild(groupEl);
            });
            document.getElementById('kuhou-count-display').textContent = `${totalKuhouCount}ä»¶è¡¨ç¤ºä¸­`;
        };
        const renderGokuList = () => {
            const container = document.getElementById('goku-container'); const query = gokuSearchQuery.toLowerCase();
            const searchFilteredGoku = query ? gokuData.filter(item => { return (item.title||'').toLowerCase().includes(query) || (item.variants||[]).some(v => v.toLowerCase().includes(query)) || (item.tags||[]).join(',').toLowerCase().includes(query) || (item.commonMemo||'').toLowerCase().includes(query) || (item.entries||[]).some(entry => (entry.reading||'').toLowerCase().includes(query) || (entry.partOfSpeech||'').toLowerCase().includes(query) || (entry.meanings||[]).join(',').toLowerCase().includes(query) || (entry.example?.hakubun||'').toLowerCase().includes(query) || (entry.example?.kakikudashi||'').toLowerCase().includes(query) || (entry.example?.translation||'').toLowerCase().includes(query))}) : gokuData;
            const tagFilter = new TagFilter('goku-tag-filter-container', searchFilteredGoku, (newTags) => { activeGokuTags = newTags; renderGokuList(); });
            tagFilter.activeTags = activeGokuTags; tagFilter.render();
            const filteredGoku = searchFilteredGoku.filter(item => activeGokuTags.every(tag => (item.tags || []).includes(tag)));
            container.innerHTML = '';
            filteredGoku.forEach(item => {
                const card = document.createElement('div'); card.className = 'item-card goku-card'; card.dataset.gokuId = item.id;
                const displayTitle = [item.title, ...(item.variants || [])].map(sanitizeHTML).join('ãƒ»');
                const tagsHTML = (item.tags || []).map(tag => `<span class="card-tag">${sanitizeHTML(tag)}</span>`).join('');
                const entriesHTML = (item.entries || []).map(entry => { const sanitizedMeanings = (entry.meanings || []).map(m => `<li>${sanitizeHTML(m)}</li>`).join(''); const exHTML = entry.example?.hakubun ? `<details class="details-section" style="margin-top:0; font-size:0.9em;"><summary>ä¾‹æ–‡</summary><div class="details-content"><p>${sanitizeHTML(entry.example.hakubun)}<br>${sanitizeHTML(entry.example.kakikudashi)}<br>${sanitizeHTML(entry.example.translation)}</p></div></details>` : ''; return `<div class="goku-entry"><div class="goku-entry-header"><span>${sanitizeHTML(entry.reading) || 'èª­ã¿æœªè¨­å®š'}</span><span class="goku-entry-pos">${sanitizeHTML(entry.partOfSpeech) || ''}</span></div><ol class="goku-entry-meanings">${sanitizedMeanings}</ol>${exHTML}</div>`}).join('');
                const commonDetailsHTML = (item.commonMemo || item.photo) ? `<details class="details-section"><summary>å…±é€šãƒ¡ãƒ¢ãƒ»å†™çœŸ</summary><div class="details-content">${item.commonMemo ? `<p><strong>ãƒ¡ãƒ¢</strong>${sanitizeHTML(item.commonMemo)}</p>` : ''}${item.photo ? `<p><strong>å†™çœŸ</strong><img src="${item.photo}" alt="é–¢é€£å†™çœŸ" class="details-photo"></p>`: ''}</div></details>` : '';
                card.innerHTML = `<h3>${displayTitle}</h3>${entriesHTML}<div class="card-tags" style="margin-top:15px;">${tagsHTML}</div>${commonDetailsHTML}<div class="card-actions"><button class="edit-goku-btn">ç·¨é›†</button><button class="delete-goku-btn delete-btn">å‰Šé™¤</button></div>`;
                container.appendChild(card);
            });
            document.getElementById('goku-count-display').textContent = `${filteredGoku.length}ä»¶è¡¨ç¤ºä¸­ / å…¨${gokuData.length}ä»¶`;
        };
        const downloadTemplate = (type) => { let data, fileName; if (type === 'kuhou') { data = [{"ã‚°ãƒ«ãƒ¼ãƒ—å":"ä¾‹:å¦å®šå½¢","å¥æ³•å":"ä¸","ã‚¿ã‚°":"åŸºæœ¬,å¦å®š","ç™½æ–‡":"éè€Œä¸æ”¹","æ›¸ãä¸‹ã—æ–‡":"éã¡ã¦æ”¹ã‚ã–ã‚‹","ç¾ä»£èªè¨³":"éã¡ã‚’çŠ¯ã—ã¦ã‚‚æ”¹ã‚ãªã„","è§£èª¬":"å˜ç´”ãªæ‰“ã¡æ¶ˆã—","ãƒ¡ãƒ¢":"åŸºæœ¬","ä¾‹æ–‡_ç™½æ–‡":"å›å­ä¸å™¨","ä¾‹æ–‡_æ›¸ãä¸‹ã—":"å›å­ã¯å™¨ãªã‚‰ãš","ä¾‹æ–‡_ç¾ä»£èªè¨³":"å›å­ã¯ç‰¹å®šã®ç”¨é€”ã®äººé–“ã§ã¯ãªã„","ä¾‹æ–‡_å‡ºå…¸":"è«–èª"}]; fileName = "å¥æ³•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.xlsx"; } else { data = [{"èªå¥":"å‰‡","ç•°ä½“å­—ãƒ»é¡ç¾©å­—":"å³,ä¹ƒ,ä¾¿","èª­ã¿":"ã™ãªã¯ã¡","å“è©":"æ¥ç¶šè©","æ„å‘³":"ã€å‰‡ã€‘ã€œã®å ´åˆã¯\nã€å³ã€‘ã™ãã«","ã‚¿ã‚°":"é‡è¦èª","å…±é€šãƒ¡ãƒ¢":"æ–‡è„ˆã§åˆ¤æ–­","å†™çœŸURL":"","ä¾‹æ–‡_ç™½æ–‡":"","ä¾‹æ–‡_æ›¸ãä¸‹ã—":"","ä¾‹æ–‡_ç¾ä»£èªè¨³":""}]; fileName = "èªå¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.xlsx"; } XLSX.writeFile(XLSX.utils.book_new_append_json(data, type === 'kuhou' ? 'å¥æ³•ä¸€è¦§' : 'èªå¥å¸³'), fileName); };
        const exportData = (type) => { let data; if (type === 'kuhou') { data = kuhouData.flatMap(g => g.subgroups.map(sg => ({ "ã‚°ãƒ«ãƒ¼ãƒ—å": g.groupTitle, "å¥æ³•å": sg.subgroupTitle, "ã‚¿ã‚°": (sg.tags||[]).join(','), "ç™½æ–‡": sg.card.hakubun, "æ›¸ãä¸‹ã—æ–‡": sg.card.kakikudashi, "ç¾ä»£èªè¨³": sg.card.translation, "è§£èª¬": sg.card.explanation, "ãƒ¡ãƒ¢": sg.card.memo, "ä¾‹æ–‡_ç™½æ–‡": sg.card.example?.hakubun, "ä¾‹æ–‡_æ›¸ãä¸‹ã—": sg.card.example?.kakikudashi, "ä¾‹æ–‡_ç¾ä»£èªè¨³": sg.card.example?.translation, "ä¾‹æ–‡_å‡ºå…¸": sg.card.example?.source }))); } else { data = gokuData.flatMap(item => (item.entries||[]).map(entry => ({ "èªå¥": item.title, "ç•°ä½“å­—ãƒ»é¡ç¾©å­—": (item.variants||[]).join(','), "èª­ã¿": entry.reading, "å“è©": entry.partOfSpeech, "æ„å‘³": (entry.meanings||[]).join('\n'), "ã‚¿ã‚°": (item.tags||[]).join(','), "å…±é€šãƒ¡ãƒ¢": item.commonMemo, "å†™çœŸURL": item.photo, "ä¾‹æ–‡_ç™½æ–‡": entry.example?.hakubun, "ä¾‹æ–‡_æ›¸ãä¸‹ã—": entry.example?.kakikudashi, "ä¾‹æ–‡_ç¾ä»£èªè¨³": entry.example?.translation, })) );} if(data.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ç„¡"); return; } XLSX.writeFile(XLSX.utils.book_new_append_json(data, type === 'kuhou' ? "å¥æ³•ä¸€è¦§" : "èªå¥å¸³"), type === 'kuhou' ? "å¥æ³•ãƒ‡ãƒ¼ã‚¿.xlsx" : "èªå¥ãƒ‡ãƒ¼ã‚¿.xlsx"); };
        const handleKuhouImport = (json) => { const newKuhouData = []; const groupMap = new Map(); json.forEach(row => { const groupTitle = row["ã‚°ãƒ«ãƒ¼ãƒ—å"] || "åç§°æœªè¨­å®š"; if (!groupMap.has(groupTitle)) { groupMap.set(groupTitle, { groupId: Date.now() + Math.random(), groupTitle: groupTitle, subgroups: [] });} const group = groupMap.get(groupTitle); group.subgroups.push({ subgroupId: Date.now() + Math.random(), subgroupTitle: row["å¥æ³•å"] || "åç§°æœªè¨­å®š", tags: (row["ã‚¿ã‚°"] || "").split(',').map(t=>t.trim()).filter(Boolean), card: { hakubun: row["ç™½æ–‡"] || "", kakikudashi: row["æ›¸ãä¸‹ã—æ–‡"] || "", translation: row["ç¾ä»£èªè¨³"] || "", explanation: row["è§£èª¬"] || "", memo: row["ãƒ¡ãƒ¢"] || "", example: { hakubun: row["ä¾‹æ–‡_ç™½æ–‡"], kakikudashi: row["ä¾‹æ–‡_æ›¸ãä¸‹ã—"], translation: row["ä¾‹æ–‡_ç¾ä»£èªè¨³"], source: row["ä¾‹æ–‡_å‡ºå…¸"] } } }); }); newKuhouData.push(...groupMap.values()); kuhouData = newKuhouData; };
        const handleGokuImport = (json) => { const gokuMap = new Map(); json.forEach(row => { const title = row["èªå¥"] || "åç§°æœªè¨­å®š"; if (!gokuMap.has(title)) { gokuMap.set(title, { id: Date.now() + Math.random(), title: title, variants: (row["ç•°ä½“å­—ãƒ»é¡ç¾©å­—"] || "").split(',').map(t=>t.trim()).filter(Boolean), entries: [], tags: (row["ã‚¿ã‚°"] || "").split(',').map(t=>t.trim()).filter(Boolean), commonMemo: row["å…±é€šãƒ¡ãƒ¢"] || "", photo: row["å†™çœŸURL"] || "" }); } const item = gokuMap.get(title); if(row["èª­ã¿"] || row["æ„å‘³"]){ item.entries.push({ reading: row["èª­ã¿"] || "", partOfSpeech: row["å“è©"] || "", meanings: (row["æ„å‘³"] || "").split('\n').filter(Boolean), example: { hakubun: row["ä¾‹æ–‡_ç™½æ–‡"], kakikudashi: row["ä¾‹æ–‡_æ›¸ãä¸‹ã—"], translation: row["ä¾‹æ–‡_ç¾ä»£èªè¨³"] } }); } }); gokuData = [...gokuMap.values()]; };
        const handleFileImport = (e) => { const file = e.target.files[0]; if (!file || !currentImportHandler) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, {type: 'array'}); const sheetName = workbook.SheetNames[0]; const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]); if (json.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ç„¡"); return; } if (!confirm("ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return; currentImportHandler(json); saveAndRender(); alert("å®Œäº†"); } catch (error) { console.error(error); alert("å¤±æ•—"); } finally { importFileInput.value = ''; currentImportHandler = null; } }; reader.readAsArrayBuffer(file); };
        const createShareLink = () => { if (gokuData.length === 0) { alert("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ç„¡"); return; } const dataToShare = { goku: gokuData }; const jsonString = JSON.stringify(dataToShare); const compressedString = LZString.compressToEncodedURIComponent(jsonString); const url = `${location.protocol}//${location.host}${location.pathname}#data=${compressedString}`; navigator.clipboard.writeText(url).then(() => alert("ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"), () => alert("ã‚³ãƒ”ãƒ¼å¤±æ•—")); };
        const loadFromURL = () => { if (!location.hash.startsWith("#data=")) return; const compressedString = location.hash.substring(6); try { const jsonString = LZString.decompressFromEncodedURIComponent(compressedString); const data = JSON.parse(jsonString); if (data.goku) { if (confirm("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼ï¼Ÿ")) { gokuData = data.goku; saveAndRender(); alert("å®Œäº†"); }} } catch (error) { console.error("URL", error); alert("ç„¡åŠ¹ãƒªãƒ³ã‚¯"); } finally { history.replaceState(null, null, ' '); } };
        const showModal = (title, content, onSave, footerContent = '') => { const leftActionHTML = footerContent ? `<div class="left-action">${footerContent}</div>` : ''; modalContainer.innerHTML = `<h2>${sanitizeHTML(title)}</h2><div class="modal-content">${content}</div><div class="modal-actions">${leftActionHTML}<button id="modal-cancel-btn" class="btn btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="modal-save-btn" class="btn btn-save">ä¿å­˜</button></div>`; modalOverlay.classList.remove('hidden'); modalContainer.classList.remove('hidden'); currentModalSaveHandler = onSave; };
        const hideModal = () => { modalOverlay.classList.add('hidden'); modalContainer.classList.add('hidden'); modalContainer.innerHTML = ''; currentModalSaveHandler = null; };
        const openGroupForm = (group = null) => { const isEdit = group !== null; const title = isEdit ? 'ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç·¨é›†' : 'æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ '; const formHTML = `<form id="group-form-modal"><label>ã‚°ãƒ«ãƒ¼ãƒ—å</label><input type="text" id="group-title" value="${isEdit ? sanitizeHTML(group.groupTitle) : ''}" required></form>`; showModal(title, formHTML, () => { const newTitle = document.getElementById('group-title').value.trim(); if (newTitle) { if (isEdit) { group.groupTitle = newTitle; } else { kuhouData.push({ groupId: Date.now(), groupTitle: newTitle, subgroups: [] }); } saveAndRender(); hideModal(); } }); };
        const openSubgroupForm = (group, subgroup = null) => {
            const isEdit = subgroup !== null; const card = isEdit ? subgroup.card : {}; const tags = isEdit ? (subgroup.tags || []).join(', ') : ''; const title = isEdit ? 'å¥æ³•ã‚’ç·¨é›†' : 'æ–°è¦å¥æ³•ã‚’è¿½åŠ '; const ex = card.example || {};
            const formHTML = `<form id="subgroup-form-modal"><label>å¥æ³•å</label><input type="text" id="subgroup-title" value="${isEdit ? sanitizeHTML(subgroup.subgroupTitle) : ''}" required><label>ã‚¿ã‚°(ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><input type="text" id="tags" value="${sanitizeHTML(tags)}"><label>ç™½æ–‡</label><textarea id="card-hakubun">${sanitizeHTML(card.hakubun || '')}</textarea><label>æ›¸ãä¸‹ã—æ–‡</label><textarea id="card-kakikudashi">${sanitizeHTML(card.kakikudashi || '')}</textarea><label>ç¾ä»£èªè¨³</label><textarea id="card-translation">${sanitizeHTML(card.translation || '')}</textarea><label>è§£èª¬</label><textarea id="card-explanation">${sanitizeHTML(card.explanation || '')}</textarea><label>ãƒ¡ãƒ¢</label><textarea id="card-memo">${sanitizeHTML(card.memo || '')}</textarea><fieldset><legend>ä¾‹æ–‡</legend><label>ç™½æ–‡</label><input type="text" class="ex-hakubun" value="${sanitizeHTML(ex.hakubun||'')}"><label>æ›¸ãä¸‹ã—æ–‡</label><input type="text" class="ex-kakikudashi" value="${sanitizeHTML(ex.kakikudashi||'')}"><label>ç¾ä»£èªè¨³</label><input type="text" class="ex-translation" value="${sanitizeHTML(ex.translation||'')}"><label>å‡ºå…¸</label><input type="text" class="ex-source" value="${sanitizeHTML(ex.source||'')}"></fieldset></form>`;
            showModal(title, formHTML, () => {
                const form = document.getElementById('subgroup-form-modal'); const newSubgroupTitle = form.querySelector('#subgroup-title').value.trim(); if(!newSubgroupTitle) { alert('å¥æ³•åã¯å¿…é ˆã§ã™ã€‚'); return; }
                const newTags = form.querySelector('#tags').value.split(',').map(t => t.trim()).filter(Boolean);
                const newCardData = { hakubun: form.querySelector('#card-hakubun').value, kakikudashi: form.querySelector('#card-kakikudashi').value, translation: form.querySelector('#card-translation').value, explanation: form.querySelector('#card-explanation').value, memo: form.querySelector('#card-memo').value, example: { hakubun: form.querySelector('.ex-hakubun').value, kakikudashi: form.querySelector('.ex-kakikudashi').value, translation: form.querySelector('.ex-translation').value, source: form.querySelector('.ex-source').value } };
                if (isEdit) { subgroup.subgroupTitle = newSubgroupTitle; subgroup.tags = newTags; Object.assign(subgroup.card, newCardData); } 
                else { group.subgroups.push({ subgroupId: Date.now(), subgroupTitle: newSubgroupTitle, tags: newTags, card: { cardId: Date.now()+1, ...newCardData } }); }
                saveAndRender(); hideModal();
            });
        };
        const processImageFile = (file) => new Promise((resolve, reject) => { const MAX_WIDTH = 800; const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { let width = img.width, height = img.height; if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.8)); }; img.onerror = reject; img.src = e.target.result; }; reader.onerror = reject; reader.readAsDataURL(file); });
        const openGokuForm = (gokuItem = null) => {
            const isEdit = gokuItem !== null; const title = isEdit ? 'èªå¥ã‚’ç·¨é›†' : 'æ–°è¦èªå¥ã‚’è¿½åŠ ';
            let tempPhotoData = isEdit ? gokuItem.photo || '' : '';
            const createEntryHTML = (entry = {}) => { const ex = entry.example || {}; return `<fieldset class="goku-entry-form"><legend>èª­ã¿ãƒ»æ„å‘³ã‚»ãƒƒãƒˆ</legend><button type="button" class="delete-entry-btn delete-btn" style="float:right;">å‰Šé™¤</button><label>èª­ã¿</label><input type="text" class="goku-reading" value="${sanitizeHTML(entry.reading || '')}"><label>å“è©</label><input type="text" class="goku-pos" value="${sanitizeHTML(entry.partOfSpeech || '')}"><label>æ„å‘³(æ”¹è¡Œã§è¤‡æ•°)</label><textarea class="goku-meanings">${sanitizeHTML((entry.meanings || []).join('\n'))}</textarea><fieldset><legend>ä¾‹æ–‡</legend><label>ç™½æ–‡</label><input type="text" class="ex-hakubun" value="${sanitizeHTML(ex.hakubun||'')}"><label>æ›¸ãä¸‹ã—æ–‡</label><input type="text" class="ex-kakikudashi" value="${sanitizeHTML(ex.kakikudashi||'')}"><label>ç¾ä»£èªè¨³</label><input type="text" class="ex-translation" value="${sanitizeHTML(ex.translation||'')}"></fieldset></fieldset>`; };
            const entries = (isEdit && Array.isArray(gokuItem.entries) && gokuItem.entries.length > 0) ? gokuItem.entries : [{}];
            const formHTML = `<form id="goku-form-modal"><label>èªå¥ï¼ˆä»£è¡¨è¡¨è¨˜ï¼‰</label><input type="text" id="goku-title" value="${isEdit ? sanitizeHTML(gokuItem.title) : ''}" required><label>ç•°ä½“å­—ãƒ»é¡ç¾©å­—(ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><input type="text" id="goku-variants" value="${isEdit ? sanitizeHTML((gokuItem.variants || []).join(', ')) : ''}"><div id="goku-entries-container">${entries.map(createEntryHTML).join('')}</div><label>å…±é€šãƒ¡ãƒ¢</label><textarea id="goku-common-memo">${isEdit ? sanitizeHTML(gokuItem.commonMemo || '') : ''}</textarea><label>ã‚¿ã‚°(ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><input type="text" id="tags" value="${isEdit ? sanitizeHTML((gokuItem.tags || []).join(', ')) : ''}"><fieldset><legend>å†™çœŸ</legend><label for="goku-photo-file">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</label><input type="file" id="goku-photo-file" accept="image/*"><img id="photo-preview" class="${tempPhotoData ? '' : 'hidden'}" src="${tempPhotoData}"><label for="goku-photo-url">ã¾ãŸã¯ URLã‚’å…¥åŠ›</label><input type="text" id="goku-photo-url" value="${tempPhotoData.startsWith('data:') ? '' : sanitizeHTML(tempPhotoData)}" placeholder="https://..."></fieldset></form>`;
            showModal(title, formHTML, () => {
                const form = document.getElementById('goku-form-modal');
                const newTitle = form.querySelector('#goku-title').value.trim();
                if (newTitle) {
                    const finalPhotoData = form.querySelector('#goku-photo-url').value.trim() || tempPhotoData;
                    const newVariants = form.querySelector('#goku-variants').value.split(',').map(t => t.trim()).filter(Boolean);
                    const newEntries = [...form.querySelectorAll('.goku-entry-form')].map(fieldset => ({ reading: fieldset.querySelector('.goku-reading').value, partOfSpeech: fieldset.querySelector('.goku-pos').value, meanings: fieldset.querySelector('.goku-meanings').value.trim().split('\n').filter(Boolean), example: { hakubun: fieldset.querySelector('.ex-hakubun').value, kakikudashi: fieldset.querySelector('.ex-kakikudashi').value, translation: fieldset.querySelector('.ex-translation').value } }));
                    if(newEntries.length === 0 || (newEntries.length === 1 && !newEntries[0].reading && newEntries[0].meanings.length === 0) ) { alert('ã€Œèª­ã¿ãƒ»æ„å‘³ã‚»ãƒƒãƒˆã€ã‚’æœ€ä½ä¸€ã¤ã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                    const newTags = form.querySelector('#tags').value.split(',').map(t => t.trim()).filter(Boolean); 
                    const newCommonMemo = form.querySelector('#goku-common-memo').value;
                    if (isEdit) { Object.assign(gokuItem, {title: newTitle, variants: newVariants, entries: newEntries, tags: newTags, commonMemo: newCommonMemo, photo: finalPhotoData }); } 
                    else { gokuData.push({ id: Date.now(), title: newTitle, variants: newVariants, entries: newEntries, tags: newTags, commonMemo: newCommonMemo, photo: finalPhotoData }); }
                    saveAndRender(); hideModal();
                }
            }, `<div class="left-action"><button type="button" id="add-entry-btn" class="btn btn-sub-action">ï¼‹ èª­ã¿ãƒ»æ„å‘³ã‚»ãƒƒãƒˆã‚’è¿½åŠ </button></div>`);
            
            const gokuEntriesContainer = document.getElementById('goku-entries-container');
            if (gokuEntriesContainer) {
                gokuEntriesContainer.addEventListener('click', e => { if(e.target.classList.contains('delete-entry-btn')) { if (document.querySelectorAll('.goku-entry-form').length > 1) { e.target.closest('.goku-entry-form').remove(); } else { alert('æœ€å¾Œã®ã‚»ãƒƒãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚'); } } });
            }
            const addEntryBtn = document.getElementById('add-entry-btn');
            if(addEntryBtn) { addEntryBtn.addEventListener('click', () => { gokuEntriesContainer.insertAdjacentHTML('beforeend', createEntryHTML()); }); }
            const photoFile = document.getElementById('goku-photo-file');
            if(photoFile){ photoFile.addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) { try { const resizedDataUrl = await processImageFile(file); tempPhotoData = resizedDataUrl; document.getElementById('photo-preview').src = resizedDataUrl; document.getElementById('photo-preview').classList.remove('hidden'); document.getElementById('goku-photo-url').value = ''; } catch (err) { alert('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); } } }); }
        };
        
        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        document.addEventListener('click', (e) => {
            const { target } = e;
            if (target.closest('.modal-actions')) { if (target.id === 'modal-save-btn' && currentModalSaveHandler) { currentModalSaveHandler(); } if (target.id === 'modal-cancel-btn') { hideModal(); } return; }
            if (target.id === 'modal-overlay') { hideModal(); return; }
            if (target.closest('.subgroup > details > summary') && !target.closest('.actions')) { return; }
            const kuhouAction = target.closest('.kuhou-action');
            if (kuhouAction) { const action = kuhouAction.dataset.action; if (action === 'import') { currentImportHandler = handleKuhouImport; importFileInput.click(); } else if (action === 'export-excel') exportData('kuhou'); else if (action === 'download-template') downloadTemplate('kuhou'); return; }
            const gokuAction = target.closest('.goku-action');
            if (gokuAction) { const action = gokuAction.dataset.action; if (action === 'import') { currentImportHandler = handleGokuImport; importFileInput.click(); } else if (action === 'export-excel') exportData('goku'); else if (action === 'download-template') downloadTemplate('goku'); else if (action === 'share') createShareLink(); return; }
            if (target.id === 'add-group-btn') { openGroupForm(); return; }
            if (target.id === 'add-goku-btn') { openGokuForm(); return; }
            const groupEl = target.closest('.kuhou-group');
            if(groupEl){
                const groupId = Number(groupEl.dataset.groupId); const group = kuhouData.find(g => g.groupId === groupId); if (!group) return;
                const subgroupEl = target.closest('.subgroup');
                if (subgroupEl) {
                    const subgroupId = Number(subgroupEl.dataset.subgroupId); const subgroup = group.subgroups.find(sg => sg.subgroupId === subgroupId); if (!subgroup) return;
                    if (target.classList.contains('edit-subgroup-btn')) { e.preventDefault(); openSubgroupForm(group, subgroup); } 
                    else if (target.classList.contains('delete-subgroup-btn')) { e.preventDefault(); if (confirm(`å¥æ³•ã€Œ${sanitizeHTML(subgroup.subgroupTitle)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { group.subgroups = group.subgroups.filter(sg => sg.subgroupId !== subgroupId); saveAndRender(); } }
                } else {
                    if (target.classList.contains('add-subgroup-btn')) { e.preventDefault(); openSubgroupForm(group); }
                    else if (target.classList.contains('edit-group-btn')) { e.preventDefault(); openGroupForm(group); }
                    else if (target.classList.contains('delete-group-btn')) { e.preventDefault(); if (confirm(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${sanitizeHTML(group.groupTitle)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { kuhouData = kuhouData.filter(g => g.groupId !== groupId); saveAndRender(); } }
                    else if (target.classList.contains('reorder-group-up-btn')) { e.preventDefault(); const i = kuhouData.indexOf(group); if (i > 0) { [kuhouData[i], kuhouData[i-1]] = [kuhouData[i-1], kuhouData[i]]; saveAndRender(); } }
                    else if (target.classList.contains('reorder-group-down-btn')) { e.preventDefault(); const i = kuhouData.indexOf(group); if (i < kuhouData.length - 1) { [kuhouData[i], kuhouData[i+1]] = [kuhouData[i+1], kuhouData[i]]; saveAndRender(); } }
                }
                return;
            }
            const gokuCardEl = target.closest('.goku-card');
            if (gokuCardEl) {
                const gokuId = Number(gokuCardEl.dataset.gokuId); const gokuItem = gokuData.find(g => g.id === gokuId); if (!gokuItem) return;
                if (target.classList.contains('edit-goku-btn')) { openGokuForm(gokuItem); }
                else if (target.classList.contains('delete-goku-btn')) { if (confirm(`èªå¥ã€Œ${sanitizeHTML(gokuItem.title)}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { gokuData = gokuData.filter(g => g.id !== gokuId); saveAndRender(); } }
                return;
            }
            if (target.classList.contains('toggle-visibility')) { const fieldEl = target.closest('.field'); if (fieldEl) { const contentEl = fieldEl.querySelector('.content'); if (contentEl) contentEl.classList.toggle('hidden'); } }
        });
        document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.tab)));
        kuhouSearchBox.addEventListener('input', (e) => { kuhouSearchQuery = e.target.value; render(); });
        gokuSearchBox.addEventListener('input', (e) => { gokuSearchQuery = e.target.value; render(); });
        importFileInput.addEventListener('change', handleFileImport);
        loadData(); loadFromURL(); switchView(activeTab);
    });
    </script>
</body>
</html>
